name: Tests

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  lint:
    name: Lint & static checks
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12.3
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.3"

      - name: Install system build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gobject-introspection \
            libgirepository1.0-dev \
            libcairo2-dev \
            libffi-dev \
            build-essential \
            python3-dev \
            meson \
            ninja-build \
            pkg-config \
            gir1.2-gtk-3.0

      - name: Install Python dependencies (project)
        uses: ./.github/actions/install-python-dependencies

      - name: Generate config.py
        run: |
          cd src/utils
          python generate_config.py

      - name: Compile QT resources
        run: |
          poetry run pyside6-rcc src/resources.qrc -o src/resources_rc.py

      - name: Code quality checks
        run: |
          pip install pre-commit
          pre-commit run --all-files --show-diff-on-failure

  unit-tests:
    name: Unit tests
    runs-on: ubuntu-22.04
    env:
      QT_QPA_PLATFORM: offscreen
      TZ: Asia/Kolkata
      PYTHON_KEYRING_BACKEND: keyrings.alt.file.PlaintextKeyring
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12.3 environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.3"

      - name: Install required system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxcb-cursor0 \
            libegl1 \
            libgl1 \
            ruby-dev \
            build-essential \
            libgirepository1.0-dev \
            python3-dev \
            libfuse2 \
            gobject-introspection \
            meson \
            ninja-build \
            pkg-config \
            libcairo2-dev \
            libffi-dev
          sudo gem install fpm -f

      - name: Generate config.py
        run: |
          cd src/utils
          python generate_config.py

      - name: Preinstall keyring backends (system Python)
        run: |
          pip install keyring keyrings.alt

      - name: Install Python dependencies
        uses: ./.github/actions/install-python-dependencies

      - name: Install keyring backends in Poetry venv
        run: |
          poetry run pip install keyring keyrings.alt

      - name: Set KEYRING_HOME env
        run: |
          echo "KEYRING_HOME=$RUNNER_TEMP/keyring" >> "$GITHUB_ENV"

      - name: Ensure keyring storage directory exists
        run: |
          mkdir -p "$KEYRING_HOME"

      - name: Compile QT resources
        run: |
          poetry run pyside6-rcc src/resources.qrc -o src/resources_rc.py

      - name: Run unit tests (fail if coverage < 90%)
        run: |
          poetry run pytest -v --maxfail=1 \
            --cov=src \
            --cov-fail-under=90 \
            unit_tests/tests

  e2e-dogtail:
    name: E2E Dogtail tests
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    env:
      DISPLAY: :99
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12.3 environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.3"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.3
          virtualenvs-create: true
          virtualenvs-in-project: false
          installer-parallel: true

      - name: Check Poetry
        run: poetry --version

      - name: Install required system dependencies
        run: |
          sudo apt-get install -y \
            xvfb \
            x11-apps \
            xauth \
            openbox \
            dbus-x11 \
            at-spi2-core \
            libatk-bridge2.0-0 \
            libxcb-cursor0 \
            libxkbcommon-x11-0 \
            libxkbcommon0 \
            libxcb1 \
            libxcb-xinerama0 \
            libxcb-xfixes0 \
            libxcb-randr0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-shm0 \
            libxcb-glx0 \
            libxcb-render0 \
            libxcb-present0 \
            libxcb-dri3-0 \
            libxcb-xinput0 \
            libx11-xcb1 \
            libxrender1 \
            libxcomposite1 \
            libxi6 \
            libxtst6 \
            libxrandr2 \
            libxdamage1 \
            libxext6 \
            libfontconfig1 \
            libdrm2 \
            libegl1 \
            libgl1 \
            libgtk-3-0 \
            gir1.2-gtk-3.0 \
            gir1.2-atspi-2.0 \
            python3-gi \
            xdg-desktop-portal \
            xdg-desktop-portal-gtk \
            qt6-gtk-platformtheme \
            fonts-dejavu-core \
            adwaita-icon-theme \
            shared-mime-info \
            libgl1-mesa-dri \
            mesa-utils \
            libgirepository1.0-dev \
            meson \
            gobject-introspection \
            ninja-build \
            gsettings-desktop-schemas \
            dconf-cli \
            dconf-service \
            xclip \
            wmctrl \
            libdbus-1-3 \
            libglib2.0-0 \
            libnss3 \
            libxss1 \
            libatk1.0-0 \
            libxcb-util1 \
            ruby-dev \
            build-essential \
            libgl1-mesa-glx \
            libegl1-mesa \
            libgbm1 \
            libosmesa6 \
            mesa-utils-extra \
            libfuse2
          sudo gem install fpm -f

      - name: Setup env for GUI testing
        run: |
          echo "LIBGL_ALWAYS_SOFTWARE=1" >> $GITHUB_ENV
          echo "MESA_LOADER_DRIVER_OVERRIDE=llvmpipe" >> $GITHUB_ENV

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Preinstall keyring backends (system Python)
        run: |
          pip install keyring keyrings.alt

      - name: Install Python dependencies
        uses: ./.github/actions/install-python-dependencies

      - name: Install keyring backends in Poetry venv
        run: |
          poetry run pip install keyring keyrings.alt

      - name: Set KEYRING_HOME env
        run: |
          echo "KEYRING_HOME=$RUNNER_TEMP/keyring" >> "$GITHUB_ENV"

      - name: Ensure keyring storage directory exists
        run: |
          mkdir -p "$KEYRING_HOME"

      - name: Start Xvfb and openbox
        run: |
          export XAUTHORITY="$RUNNER_TEMP/.Xauthority"
          touch "$XAUTHORITY"
          xauth -f "$XAUTHORITY" add :99 . $(mcookie)
          echo "XAUTHORITY=$XAUTHORITY" >> $GITHUB_ENV

          Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset &
          echo "XVFB_PID=$!" >> $GITHUB_ENV
          sleep 4

          openbox &
          sleep 3

      - name: Debug OpenGL
        run: glxinfo | grep "OpenGL" || echo "No OpenGL"

      # - name: Build the rgb-lightning-node binary (disabled; using prebundled ln_node_binary)
      #   uses: ./.github/actions/build-rln-node

      - name: Add rgb-lightning-node to PATH
        run: |
          chmod +x ln_node_binary/rgb-lightning-node
          echo "$GITHUB_WORKSPACE/ln_node_binary" >> $GITHUB_PATH

      - name: Compile QT resources
        run: |
          poetry run pyside6-rcc src/resources.qrc -o src/resources_rc.py

      # - name: Start Xvfb (headless display) and prepare XAUTHORITY
      #   run: |
      #     export XAUTHORITY="${XAUTHORITY:-$RUNNER_TEMP/.Xauthority}"
      #     mkdir -p "$(dirname "$XAUTHORITY")"
      #     touch "$XAUTHORITY"
      #     cookie=$(mcookie)
      #     xauth -f "$XAUTHORITY" add :99 . "$cookie"
      #     echo "XAUTHORITY=$XAUTHORITY" >> $GITHUB_ENV
      #     Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset &

      #     echo "XVFB_PID=$!" >> $GITHUB_ENV
      #     sleep 3

      # - name: Debug OpenGL
      #   run: glxinfo | grep "OpenGL"

      - name: Ensure E2E scripts are executable
        run: |
          chmod +x run_e2e_tests.sh
          chmod +x e2e_tests/regtest.sh

      - name: Fetch AppImages from Drive/URLs into e2e_tests/applications
        env:
          APP1_APPIMAGE_URL: ${{ secrets.APP1_APPIMAGE_URL }}
          APP2_APPIMAGE_URL: ${{ secrets.APP2_APPIMAGE_URL }}
          APP1_GDRIVE_ID: ${{ secrets.APP1_GDRIVE_ID }}
          APP2_GDRIVE_ID: ${{ secrets.APP2_GDRIVE_ID }}
        run: |
          set -euo pipefail
          VERSION=$(grep '__version__' ./src/version.py | awk -F'=' '{print $2}' | tr -d ' "' | xargs)
          APP1_NAME=$(grep '^APP1_NAME' accessible_constant.py | awk -F'=' '{print $2}' | tr -d ' "' | xargs)
          APP2_NAME=$(grep '^APP2_NAME' accessible_constant.py | awk -F'=' '{print $2}' | tr -d ' "' | xargs)
          APPDIR=e2e_tests/applications
          mkdir -p "$APPDIR"

          APP1_FILE="iriswallet_${APP1_NAME}-${VERSION}-x86_64.AppImage"
          APP2_FILE="iriswallet_${APP2_NAME}-${VERSION}-x86_64.AppImage"

          need_gdown=false

          fetch_one() {
            local url="$1"; local gid="$2"; local out="$3"
            if [ -n "$url" ]; then
              echo "Downloading $out from URL..."
              if echo "$url" | grep -qi "drive.google.com"; then
                echo "Detected Google Drive URL; using gdown..."
                python -m pip install --quiet gdown
                gdown --fuzzy "$url" -O "$out" || { echo "gdown failed for $out"; exit 1; }
              else
                curl -L --fail --silent --show-error -o "$out" "$url" || { echo "Failed to download $out from URL"; exit 1; }
              fi
              return 0
            fi
            if [ -n "$gid" ]; then
              need_gdown=true
              echo "Will download $out from Google Drive ID $gid"
              echo "$gid $out" >> /tmp/gdrive_list
              return 0
            fi
            return 1
          }

          rm -f /tmp/gdrive_list

          # Try to queue downloads if URLs/IDs provided
          fetch_one "${APP1_APPIMAGE_URL:-}" "${APP1_GDRIVE_ID:-}" "$APPDIR/$APP1_FILE"
          fetch_one "${APP2_APPIMAGE_URL:-}" "${APP2_GDRIVE_ID:-}" "$APPDIR/$APP2_FILE"

          # Perform gdown downloads if needed
          if [ "$need_gdown" = true ]; then
            python -m pip install --quiet gdown
            while read -r gid outfile; do
              echo "Downloading $(basename "$outfile") from Google Drive..."
              gdown --fuzzy "https://drive.google.com/uc?id=$gid" -O "$outfile"
            done < <(cat /tmp/gdrive_list)
          fi

          # chmod +x for any downloaded files
          for f in "$APPDIR/$APP1_FILE" "$APPDIR/$APP2_FILE"; do
            if [ -f "$f" ]; then
              chmod +x "$f"
              # Validate ELF binary to avoid Exec format error from HTML/redirects
              if ! file "$f" | grep -q "ELF .* x86-64"; then
                echo "Downloaded file is not a valid x86_64 ELF AppImage: $f"
                echo "file output:" && file "$f"
                echo "head -n 5:" && head -n 5 "$f" || true
                echo "Consider providing a direct asset URL or use APP*_GDRIVE_ID secrets."
                exit 1
              fi
            fi
          done

      - name: Prepare runtime Python deps for AppImage (keyring backends)
        run: |
          RUNTIME_PYDEPS="$RUNNER_TEMP/pydeps"
          mkdir -p "$RUNTIME_PYDEPS"
          python -m pip install --upgrade pip
          python -m pip install --target "$RUNTIME_PYDEPS" keyring keyrings.alt
          echo "PYTHONPATH=$RUNTIME_PYDEPS" >> $GITHUB_ENV

      - name: Install lightweight window manager for Xvfb
        run: |
          sudo apt-get install -y --no-install-recommends openbox wmctrl dbus-x11

      - name: Start regtest services (Docker)
        run: |
          poetry run regtest-start

      - name: Run E2E tests (build if missing and run for both modes)
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          PROJECT_ID: ${{ secrets.PROJECT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          BACKUP_EMAIL_ID: ${{ secrets.BACKUP_EMAIL_ID }}
          BACKUP_EMAIL_PASSWORD: ${{ secrets.BACKUP_EMAIL_PASSWORD }}
          GOOGLE_AUTHENTICATOR: ${{ secrets.GOOGLE_AUTHENTICATOR }}
          LD_LIBRARY_PATH: /usr/local/lib
          QT_QPA_PLATFORM: xcb
          APPIMAGE_EXTRACT_AND_RUN: '1'
        run: |
          cd src/utils
          python generate_config.py
          cd ../../
          dbus-run-session -- bash -lc '
          set -euo pipefail
          export DISPLAY=:99
          export NO_AT_BRIDGE=0
          export GTK_MODULES=atk-bridge
          export QT_QPA_PLATFORM=xcb
          export GDK_BACKEND=x11
          export XDG_CURRENT_DESKTOP=GNOME
          export GTK_USE_PORTAL=1
          export QT_QPA_PLATFORMTHEME=gtk3
          export QT_OPENGL=software
          export QT_XCB_GL_INTEGRATION=none
          export LIBGL_ALWAYS_SOFTWARE=1
          export QT_X11_NO_MITSHM=1
          export XAUTHORITY="${XAUTHORITY:-$RUNNER_TEMP/.Xauthority}"
          export LANG=C.UTF-8
          export LC_ALL=C.UTF-8
          export APPIMAGE_EXTRACT_AND_RUN=1
          export KEYRING_HOME="$RUNNER_TEMP/keyring"
          mkdir -p "$KEYRING_HOME"
          export PYTHON_KEYRING_BACKEND=keyrings.alt.file.PlaintextKeyring
          export PYTHONPATH="$RUNNER_TEMP/pydeps:$PYTHONPATH"
          export PYTHONNOUSERSITE=0
          export XDG_RUNTIME_DIR="$RUNNER_TEMP/xdg"
          mkdir -p "$XDG_RUNTIME_DIR" && chmod 700 "$XDG_RUNTIME_DIR"
          export GSETTINGS_BACKEND=dconf
          gsettings set org.gnome.desktop.interface toolkit-accessibility true
          /usr/lib/at-spi2-core/at-spi-bus-launcher --launch-immediately &
          /usr/lib/at-spi2-core/at-spi2-registryd &
          export PATH="$GITHUB_WORKSPACE/ln_node_binary:$PATH"
          dbus-update-activation-environment DISPLAY XAUTHORITY QT_ACCESSIBILITY QT_LINUX_ACCESSIBILITY_ALWAYS_ON NO_AT_BRIDGE GTK_MODULES GDK_BACKEND PYTHON_KEYRING_BACKEND KEYRING_HOME APPIMAGE_EXTRACT_AND_RUN PATH
          export QT_QUICK_BACKEND=software
          export QTWEBENGINE_CHROMIUM_FLAGS="--disable-gpu --disable-software-rasterizer"
          export QT_OPENGL=software
          export QT_XCB_GL_INTEGRATION=none
          export QT_QPA_PLATFORM=xcb       # (already set earlier but safe)
          export LIBGL_ALWAYS_SOFTWARE=1
          export MESA_LOADER_DRIVER_OVERRIDE=llvmpipe
          export QTWEBENGINE_DISABLE_SANDBOX=1
          export QTWEBENGINE_NO_SANDBOX=1
          openbox &
          sleep 6  # Wait for Xvfb to start
          poetry run single-test test_settings.py
          '

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failure-screenshots
          path: /tmp/screenshot_*.png
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results-*
          retention-days: 30
          if-no-files-found: ignore

      - name: Generate Allure Report
        if: always()
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: allure-results-*
          allure_history: allure-history
          keep_reports: 20

      - name: Publish Allure Report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history
