name: Tests

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  lint:
    name: Lint & static checks
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12.3
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.3"

      - name: Install system build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gobject-introspection \
            libgirepository1.0-dev \
            libcairo2-dev \
            libffi-dev \
            build-essential \
            python3-dev \
            meson \
            ninja-build \
            pkg-config \
            gir1.2-gtk-3.0

      - name: Install Python dependencies (project)
        uses: ./.github/actions/install-python-dependencies

      - name: Generate config.py
        run: |
          cd src/utils
          python generate_config.py

      - name: Compile QT resources
        run: |
          poetry run pyside6-rcc src/resources.qrc -o src/resources_rc.py

      - name: Code quality checks
        run: |
          pip install pre-commit
          pre-commit run --all-files --show-diff-on-failure

  unit-tests:
    name: Unit tests
    runs-on: ubuntu-22.04
    env:
      QT_QPA_PLATFORM: offscreen
      TZ: Asia/Kolkata
      PYTHON_KEYRING_BACKEND: keyrings.alt.file.PlaintextKeyring
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12.3 environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.3"

      - name: Install required system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxcb-cursor0 \
            libegl1 \
            libgl1 \
            ruby-dev \
            build-essential \
            libgirepository1.0-dev \
            python3-dev \
            libfuse2 \
            gobject-introspection \
            meson \
            ninja-build \
            pkg-config \
            libcairo2-dev \
            libffi-dev
          sudo gem install fpm -f

      - name: Generate config.py
        run: |
          cd src/utils
          python generate_config.py

      - name: Preinstall keyring backends (system Python)
        run: |
          pip install keyring keyrings.alt

      - name: Install Python dependencies
        uses: ./.github/actions/install-python-dependencies

      - name: Install keyring backends in Poetry venv
        run: |
          poetry run pip install keyring keyrings.alt

      - name: Set KEYRING_HOME env
        run: |
          echo "KEYRING_HOME=$RUNNER_TEMP/keyring" >> "$GITHUB_ENV"

      - name: Ensure keyring storage directory exists
        run: |
          mkdir -p "$KEYRING_HOME"

      - name: Compile QT resources
        run: |
          poetry run pyside6-rcc src/resources.qrc -o src/resources_rc.py

      - name: Run unit tests (fail if coverage < 90%)
        run: |
          poetry run pytest -v --maxfail=1 \
            --cov=src \
            --cov-fail-under=90 \
            unit_tests/tests

  e2e-dogtail:
    name: E2E Dogtail tests
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    env:
      DISPLAY: :99
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12.3 environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.3"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.3
          virtualenvs-create: true
          virtualenvs-in-project: false
          installer-parallel: true

      - name: Install required system dependencies
        run: |
          sudo apt-get install -y \
            xvfb \
            x11-apps \
            xauth \
            dbus-x11 \
            at-spi2-core \
            libatk-bridge2.0-0 \
            libxcb-cursor0 \
            libxkbcommon-x11-0 \
            libxkbcommon0 \
            libxcb1 \
            libxcb-xinerama0 \
            libxcb-xfixes0 \
            libxcb-randr0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-shm0 \
            libxcb-glx0 \
            libxcb-render0 \
            libxcb-present0 \
            libxcb-dri3-0 \
            libxcb-xinput0 \
            libx11-xcb1 \
            libxrender1 \
            libxcomposite1 \
            libxi6 \
            libxtst6 \
            libxrandr2 \
            libxdamage1 \
            libxext6 \
            libfontconfig1 \
            libdrm2 \
            libegl1 \
            libgl1 \
            libgtk-3-0 \
            gir1.2-gtk-3.0 \
            gir1.2-atspi-2.0 \
            python3-gi \
            xdg-desktop-portal \
            xdg-desktop-portal-gtk \
            qt6-gtk-platformtheme \
            fonts-dejavu-core \
            adwaita-icon-theme \
            shared-mime-info \
            libgl1-mesa-dri \
            mesa-utils \
            libgirepository1.0-dev \
            meson \
            gobject-introspection \
            ninja-build \
            gsettings-desktop-schemas \
            dconf-cli \
            dconf-service \
            xclip \
            wmctrl \
            libdbus-1-3 \
            libglib2.0-0 \
            libnss3 \
            libxss1 \
            libatk1.0-0 \
            libxcb-util1 \
            ruby-dev \
            build-essential \
            libfuse2
          sudo gem install fpm -f

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Preinstall keyring backends (system Python)
        run: |
          pip install keyring keyrings.alt

      - name: Install Python dependencies
        uses: ./.github/actions/install-python-dependencies

      - name: Install keyring backends in Poetry venv
        run: |
          poetry run pip install keyring keyrings.alt

      - name: Set KEYRING_HOME env
        run: |
          echo "KEYRING_HOME=$RUNNER_TEMP/keyring" >> "$GITHUB_ENV"

      - name: Ensure keyring storage directory exists
        run: |
          mkdir -p "$KEYRING_HOME"

      - name: Build the rgb-lightning-node binary
        uses: ./.github/actions/build-rln-node

      - name: Add rgb-lightning-node to PATH
        run: |
          chmod +x ln_node_binary/rgb-lightning-node
          echo "$GITHUB_WORKSPACE/ln_node_binary" >> $GITHUB_PATH

      - name: Compile QT resources
        run: |
          poetry run pyside6-rcc src/resources.qrc -o src/resources_rc.py

      - name: Start Xvfb (headless display) and prepare XAUTHORITY
        run: |
          export XAUTHORITY="${XAUTHORITY:-$RUNNER_TEMP/.Xauthority}"
          mkdir -p "$(dirname "$XAUTHORITY")"
          touch "$XAUTHORITY"
          cookie=$(mcookie)
          xauth -f "$XAUTHORITY" add :99 . "$cookie"
          echo "XAUTHORITY=$XAUTHORITY" >> $GITHUB_ENV
          Xvfb :99 -screen 0 1920x1080x24 -nolisten tcp -extension MIT-SHM &
          echo "XVFB_PID=$!" >> $GITHUB_ENV
          sleep 3 # Wait for Xvfb to start

      - name: Ensure E2E scripts are executable
        run: |
          chmod +x run_e2e_tests.sh
          chmod +x e2e_tests/regtest.sh

      - name: Prepare runtime Python deps for AppImage (keyring backends)
        run: |
          RUNTIME_PYDEPS="$RUNNER_TEMP/pydeps"
          mkdir -p "$RUNTIME_PYDEPS"
          python -m pip install --upgrade pip
          python -m pip install --target "$RUNTIME_PYDEPS" keyring keyrings.alt
          echo "PYTHONPATH=$RUNTIME_PYDEPS" >> $GITHUB_ENV

      - name: Install lightweight window manager for Xvfb
        run: |
          sudo apt-get install -y --no-install-recommends openbox wmctrl dbus-x11

      - name: Start regtest services (Docker)
        run: |
          poetry run regtest-start

      - name: Run E2E tests (build if missing and run for both modes)
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          PROJECT_ID: ${{ secrets.PROJECT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          LD_LIBRARY_PATH: /usr/local/lib
          QT_QPA_PLATFORM: xcb
          APPIMAGE_EXTRACT_AND_RUN: '1'
        run: |
          cd src/utils
          python generate_config.py
          cd ../../
          dbus-run-session -- bash -lc '
          set -euo pipefail
          export DISPLAY=:99
          export NO_AT_BRIDGE=0
          export GTK_MODULES=atk-bridge
          export QT_QPA_PLATFORM=xcb
          export GDK_BACKEND=x11
          export XDG_CURRENT_DESKTOP=GNOME
          export GTK_USE_PORTAL=1
          export QT_QPA_PLATFORMTHEME=gtk3
          export QT_OPENGL=software
          export QT_XCB_GL_INTEGRATION=none
          export LIBGL_ALWAYS_SOFTWARE=1
          export QT_X11_NO_MITSHM=1
          export XAUTHORITY="${XAUTHORITY:-$RUNNER_TEMP/.Xauthority}"
          export LANG=C.UTF-8
          export LC_ALL=C.UTF-8
          export APPIMAGE_EXTRACT_AND_RUN=1
          export KEYRING_HOME="$RUNNER_TEMP/keyring"
          mkdir -p "$KEYRING_HOME"
          export PYTHON_KEYRING_BACKEND=keyrings.alt.file.PlaintextKeyring
          export PYTHONPATH="$RUNNER_TEMP/pydeps:$PYTHONPATH"
          export PYTHONNOUSERSITE=0
          export XDG_RUNTIME_DIR="$RUNNER_TEMP/xdg"
          mkdir -p "$XDG_RUNTIME_DIR" && chmod 700 "$XDG_RUNTIME_DIR"
          export GSETTINGS_BACKEND=dconf
          gsettings set org.gnome.desktop.interface toolkit-accessibility true
          /usr/lib/at-spi2-core/at-spi-bus-launcher --launch-immediately &
          /usr/lib/at-spi2-core/at-spi2-registryd &
          export PATH="$GITHUB_WORKSPACE/ln_node_binary:$PATH"
          dbus-update-activation-environment DISPLAY XAUTHORITY QT_ACCESSIBILITY QT_LINUX_ACCESSIBILITY_ALWAYS_ON NO_AT_BRIDGE GTK_MODULES GDK_BACKEND PYTHON_KEYRING_BACKEND KEYRING_HOME APPIMAGE_EXTRACT_AND_RUN PATH
          openbox &
          sleep 6  # Wait for Xvfb to start
          poetry run e2e-test all
          '
